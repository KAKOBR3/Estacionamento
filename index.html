<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <title>Benedita Estacionamento Pro</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 24px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e40af;
            text-align: center;
            margin-bottom: 10px;
        }

        .login-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-entry {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            padding: 10px 20px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 68px;
            z-index: 99;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            border: none;
            background: white;
            font-weight: 600;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Content */
        .content {
            padding: 15px;
            min-height: calc(100vh - 140px);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card.blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .stat-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .stat-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        /* Vehicle Cards */
        .vehicle-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vehicle-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .vehicle-header {
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .vehicle-header.finished {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .vehicle-plate {
            font-size: 24px;
            font-weight: 700;
            font-family: monospace;
            margin-bottom: 5px;
        }

        .vehicle-control {
            font-size: 12px;
            opacity: 0.9;
        }

        .vehicle-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            background: rgba(255,255,255,0.3);
            margin-top: 8px;
        }

        .vehicle-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .vehicle-body {
            padding: 15px;
        }

        .vehicle-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #4b5563;
            font-size: 14px;
        }

        .vehicle-info.highlight {
            color: #059669;
            font-weight: 600;
            font-size: 15px;
        }

        .vehicle-info.price {
            color: #059669;
            font-weight: 700;
            font-size: 18px;
        }

        .vehicle-info.alert {
            color: #dc2626;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .vehicle-info.free {
            color: #10b981;
            font-weight: 700;
            font-size: 16px;
            background: #d1fae5;
            padding: 8px 12px;
            border-radius: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .btn-exit {
            padding: 12px;
            border: none;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-print {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        /* Search Bar */
        .search-bar {
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .search-bar input {
            flex: 1;
            border: none;
            font-size: 16px;
            outline: none;
        }

        .search-bar select {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            margin: auto;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header.exit {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
        }

        .btn-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f3f4f6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-highlight {
            font-weight: 700;
            color: #3b82f6;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .category-btn {
            padding: 20px 10px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }

        .category-btn.active {
            border-color: #10b981;
            background: #d1fae5;
            color: #059669;
        }

        .category-price {
            font-size: 11px;
            color: #6b7280;
            margin-top: 5px;
        }

        /* Camera */
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .btn-camera {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 4px solid white;
            background: #3b82f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .ocr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .ocr-result {
            background: #d1fae5;
            color: #059669;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            font-weight: 700;
            font-size: 18px;
            text-align: center;
            border: 2px solid #10b981;
        }

        .btn-submit {
            width: 100%;
            padding: 18px;
            border: none;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-submit.exit {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .summary-box {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-row:last-child {
            border-bottom: none;
            border-top: 2px solid #d1d5db;
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        /* Settings */
        .settings-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1e40af;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: #d1d5db;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #10b981;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }

        /* Price Config */
        .price-grid {
            display: grid;
            gap: 15px;
        }

        .price-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 12px;
        }

        .price-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 700;
            color: #1e40af;
        }

        .price-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .price-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .price-input-group label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
        }

        .price-input-group input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e40af;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideUpToast 0.3s ease-out;
        }

        .toast.show {
            display: flex;
        }

        @keyframes slideUpToast {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* CPF/CNPJ Input */
        .document-input {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .document-input input {
            flex: 1;
        }

        .document-type {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .document-type-btn {
            padding: 6px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .document-type-btn.active {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1e40af;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .header h1 {
                font-size: 16px;
            }
            
            .btn-header {
                padding: 6px 10px;
                font-size: 12px;
            }

            .price-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processando...</div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <div style="font-size: 60px;">üöó</div>
                <div class="login-title">Benedita Estacionamento</div>
                <div class="login-subtitle">Sistema Profissional</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Usu√°rio</label>
                <input type="text" id="loginUsername" class="form-input" placeholder="Digite seu usu√°rio">
            </div>
            
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') handleLogin()">
            </div>
            
            <button class="btn-submit" onclick="handleLogin()">
                üîê Entrar
            </button>
            
            <div style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                <p><strong>Usu√°rios padr√£o:</strong></p>
                <p>admin / admin123</p>
                <p>operador / oper123</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üöó Benedita Estacionamento</h1>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 3px;">
                        üë§ <span id="currentUserDisplay"></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-header btn-entry" onclick="openEntryModal()">
                        ‚ûï Entrada
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('dashboard')">
                <div class="nav-icon">üìä</div>
                <div>Dashboard</div>
            </button>
            <button class="nav-tab" onclick="switchView('patio')">
                <div class="nav-icon">üöó</div>
                <div>P√°tio</div>
                <div style="font-size: 10px;" id="patioCount">(0)</div>
            </button>
            <button class="nav-tab" onclick="switchView('historico')">
                <div class="nav-icon">üïê</div>
                <div>Hist√≥rico</div>
            </button>
            <button class="nav-tab" onclick="switchView('configuracoes')">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div>Config</div>
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-label">Ve√≠culos Ativos</div>
                        <div class="stat-value" id="statAtivos">0</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Receita Hoje</div>
                        <div class="stat-value" id="statReceita">R$ 0</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-label">Finalizados</div>
                        <div class="stat-value" id="statFinalizados">0</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Total</div>
                        <div class="stat-value" id="statTotal">0</div>
                    </div>
                </div>

                <div class="vehicle-card">
                    <div style="padding: 20px; background: white; border-radius: 16px;">
                        <h3 style="margin-bottom: 15px; color: #374151;">üìà Por Categoria</h3>
                        <div id="categoryStats"></div>
                    </div>
                </div>
            </div>

            <!-- Patio View -->
            <div id="patio" class="view">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" id="searchPatio" placeholder="Buscar placa, modelo..." oninput="filterVehicles('patio')">
                    <select id="filterPatio" onchange="filterVehicles('patio')">
                        <option value="todos">Todos</option>
                        <option value="pequeno">Pequeno</option>
                        <option value="grande">Grande</option>
                        <option value="moto">Moto</option>
                    </select>
                </div>
                <div id="patioList" class="vehicle-list"></div>
            </div>

            <!-- Historico View -->
            <div id="historico" class="view">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" id="searchHistorico" placeholder="Buscar placa, modelo..." oninput="filterVehicles('historico')">
                    <select id="filterHistorico" onchange="filterVehicles('historico')">
                        <option value="todos">Todos</option>
                        <option value="pequeno">Pequeno</option>
                        <option value="grande">Grande</option>
                        <option value="moto">Moto</option>
                    </select>
                </div>
                <div id="historicoList" class="vehicle-list"></div>
            </div>

            <!-- Configuracoes View -->
            <div id="configuracoes" class="view">
                <!-- Pre√ßos -->
                <div class="settings-section">
                    <div class="settings-title">üí∞ Configura√ß√£o de Pre√ßos</div>
                    <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1e40af;">
                        <strong>‚ÑπÔ∏è Como funciona:</strong><br>
                        ‚Ä¢ Toler√¢ncia: Primeiros 5 minutos s√£o GR√ÅTIS<br>
                        ‚Ä¢ 1¬™ Hora: Valor diferenciado<br>
                        ‚Ä¢ Horas seguintes: Valor adicional por hora<br>
                        ‚Ä¢ Di√°ria: Ap√≥s 12 horas
                    </div>
                    <div class="price-grid">
                        <div class="price-item">
                            <div class="price-item-header">
                                üöó Pequeno (Carro)
                            </div>
                            <div class="price-inputs">
                                <div class="price-input-group">
                                    <label>1¬™ Hora</label>
                                    <input type="number" id="precoPequenoHora1" value="10" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Hora Adicional</label>
                                    <input type="number" id="precoPequenoHoraAdd" value="5" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Di√°ria</label>
                                    <input type="number" id="precoPequenoDiaria" value="40" min="0" step="1" onchange="updatePrices()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="price-item">
                            <div class="price-item-header">
                                üöô Grande (SUV/Caminhonete)
                            </div>
                            <div class="price-inputs">
                                <div class="price-input-group">
                                    <label>1¬™ Hora</label>
                                    <input type="number" id="precoGrandeHora1" value="15" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Hora Adicional</label>
                                    <input type="number" id="precoGrandeHoraAdd" value="8" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Di√°ria</label>
                                    <input type="number" id="precoGrandeDiaria" value="60" min="0" step="1" onchange="updatePrices()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="price-item">
                            <div class="price-item-header">
                                üèçÔ∏è Moto
                            </div>
                            <div class="price-inputs">
                                <div class="price-input-group">
                                    <label>1¬™ Hora</label>
                                    <input type="number" id="precoMotoHora1" value="6" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Hora Adicional</label>
                                    <input type="number" id="precoMotoHoraAdd" value="3" min="0" step="0.5" onchange="updatePrices()">
                                </div>
                                <div class="price-input-group">
                                    <label>Di√°ria</label>
                                    <input type="number" id="precoMotoDiaria" value="25" min="0" step="1" onchange="updatePrices()">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-submit" onclick="savePrices()" style="margin-top: 15px;">
                        üíæ Salvar Pre√ßos
                    </button>
                </div>

                <div class="settings-section">
                    <div class="settings-title">üì∑ C√¢mera</div>
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 600;">Foto Obrigat√≥ria</div>
                            <div style="font-size: 12px; color: #6b7280;">Exigir foto na entrada</div>
                        </div>
                        <div class="toggle-switch" id="toggleRequiredPhoto" onclick="toggleSetting(this, 'requiredPhoto')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">üë§ Conta</div>
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 600;">Usu√°rio Logado</div>
                            <div style="font-size: 12px; color: #6b7280;" id="settingsUsername">admin</div>
                        </div>
                    </div>
                    <button class="btn-submit" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="logout()">
                        üö™ Sair
                    </button>
                </div>
            </div>
        </div>

        <!-- Entry Modal -->
        <div id="entryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Nova Entrada</h2>
                    <button class="btn-close" onclick="closeEntryModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">üì∑ Foto do Ve√≠culo (Opcional)</label>
                        <div class="camera-container" id="cameraContainer">
                            <video id="cameraVideo" class="camera-video" autoplay playsinline style="display: none;"></video>
                            <img id="cameraPreview" class="camera-preview" style="display: none;">
                            <canvas id="ocrCanvas" style="display: none;"></canvas>
                            <div id="cameraPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; flex-direction: column;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                <div>Clique para ativar c√¢mera</div>
                            </div>
                            <div class="camera-controls" id="cameraControls" style="display: none;">
                                <button class="btn-camera" onclick="capturePhotoWithOCR()">üì∏</button>
                                <button class="btn-camera" onclick="retakePhoto()" style="display: none;" id="btnRetake">üîÑ</button>
                            </div>
                            <div id="ocrOverlay" class="ocr-overlay" style="display: none;">
                                <div style="font-size: 24px; margin-bottom: 10px;">ü§ñ</div>
                                <div>Processando IA...</div>
                                <div style="font-size: 12px; margin-top: 5px;">Detectando placa</div>
                            </div>
                        </div>
                        <div id="ocrResult" class="ocr-result" style="display: none;"></div>
                        <button class="btn-submit" onclick="startCamera()" id="btnStartCamera">
                            üì∑ Ativar C√¢mera
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Placa do Ve√≠culo *</label>
                        <input type="text" id="inputPlaca" class="form-input" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <div class="category-grid">
                            <button class="category-btn active" onclick="selectCategory('pequeno')">
                                <div>üöó Pequeno</div>
                                <div class="category-price" id="pricePequeno">1¬™: R$ 10</div>
                            </button>
                            <button class="category-btn" onclick="selectCategory('grande')">
                                <div>üöô Grande</div>
                                <div class="category-price" id="priceGrande">1¬™: R$ 15</div>
                            </button>
                            <button class="category-btn" onclick="selectCategory('moto')">
                                <div>üèçÔ∏è Moto</div>
                                <div class="category-price" id="priceMoto">1¬™: R$ 6</div>
                            </button>
                        </div>
                    </div>

                    <div class="form-group autocomplete-container">
                        <label class="form-label">Modelo do Ve√≠culo</label>
                        <input 
                            type="text" 
                            id="inputModelo" 
                            class="form-input" 
                            placeholder="Ex: Toyota Corolla"
                            oninput="showAutocomplete(this.value)"
                            onfocus="showAutocomplete(this.value)"
                        >
                        <div id="autocompleteList" class="autocomplete-list"></div>
                    </div>

                    <button class="btn-submit" onclick="registerEntry()">
                        ‚úì Registrar Entrada
                    </button>
                </div>
            </div>
        </div>

        <!-- Exit Modal -->
        <div id="exitModal" class="modal">
            <div class="modal-content">
                <div class="modal-header exit">
                    <h2>üö™ Registrar Sa√≠da</h2>
                    <button class="btn-close" onclick="closeExitModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">CPF ou CNPJ (Opcional)</label>
                        <div class="document-type">
                            <button class="document-type-btn active" id="btnCPF" onclick="selectDocumentType('cpf')">CPF</button>
                            <button class="document-type-btn" id="btnCNPJ" onclick="selectDocumentType('cnpj')">CNPJ</button>
                        </div>
                        <input 
                            type="text" 
                            id="inputDocument" 
                            class="form-input" 
                            placeholder="000.000.000-00"
                            maxlength="18"
                            oninput="formatDocument()"
                        >
                    </div>

                    <div class="summary-box" id="exitSummary"></div>
                    
                    <button class="btn-submit exit" onclick="registerExit()">
                        ‚úì Confirmar Sa√≠da
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        // ==================== LISTA DE MODELOS PARA AUTOCOMPLETE ====================
        const carModels = [
            // Toyota
            'Toyota Corolla', 'Toyota Hilux', 'Toyota Etios', 'Toyota Yaris', 'Toyota RAV4',
            'Toyota SW4', 'Toyota Camry', 'Toyota Prius', 'Toyota Fielder',
            
            // Volkswagen
            'Volkswagen Gol', 'Volkswagen Polo', 'Volkswagen Virtus', 'Volkswagen T-Cross',
            'Volkswagen Nivus', 'Volkswagen Tiguan', 'Volkswagen Amarok', 'Volkswagen Saveiro',
            'Volkswagen Voyage', 'Volkswagen Fox',
            
            // Chevrolet
            'Chevrolet Onix', 'Chevrolet Prisma', 'Chevrolet S10', 'Chevrolet Tracker',
            'Chevrolet Cruze', 'Chevrolet Spin', 'Chevrolet Montana', 'Chevrolet Equinox',
            
            // Fiat
            'Fiat Uno', 'Fiat Argo', 'Fiat Mobi', 'Fiat Cronos', 'Fiat Toro',
            'Fiat Strada', 'Fiat Pulse', 'Fiat Fastback', 'Fiat Ducato',
            
            // Honda
            'Honda Civic', 'Honda City', 'Honda Fit', 'Honda HR-V', 'Honda CR-V',
            'Honda Accord', 'Honda WR-V',
            
            // Hyundai
            'Hyundai HB20', 'Hyundai Creta', 'Hyundai Tucson', 'Hyundai ix35',
            'Hyundai Santa Fe', 'Hyundai Azera', 'Hyundai Elantra',
            
            // Nissan
            'Nissan Kicks', 'Nissan Versa', 'Nissan Sentra', 'Nissan Frontier',
            'Nissan March', 'Nissan X-Trail',
            
            // Jeep
            'Jeep Renegade', 'Jeep Compass', 'Jeep Commander', 'Jeep Wrangler',
            
            // Renault
            'Renault Kwid', 'Renault Sandero', 'Renault Logan', 'Renault Duster',
            'Renault Captur', 'Renault Oroch',
            
            // Ford
            'Ford Ka', 'Ford EcoSport', 'Ford Ranger', 'Ford Territory',
            'Ford Focus', 'Ford Fusion',
            
            // Peugeot
            'Peugeot 208', 'Peugeot 2008', 'Peugeot 3008', 'Peugeot 5008',
            
            // Citro√´n
            'Citro√´n C3', 'Citro√´n C4 Cactus', 'Citro√´n Aircross',
            
            // Mercedes-Benz
            'Mercedes-Benz Classe A', 'Mercedes-Benz Classe C', 'Mercedes-Benz GLA',
            
            // BMW
            'BMW S√©rie 1', 'BMW S√©rie 3', 'BMW X1', 'BMW X3',
            
            // Audi
            'Audi A3', 'Audi Q3', 'Audi A4',
            
            // Motos
            'Honda CG 160', 'Honda Biz 125', 'Honda PCX', 'Honda CB 250F',
            'Yamaha Factor 150', 'Yamaha YS 150', 'Yamaha MT-03',
            'Suzuki Burgman', 'Harley-Davidson', 'BMW GS 1200'
        ].sort();

        // ==================== GLOBAL STATE ====================
        let vehicles = [];
        let selectedCategory = 'pequeno';
        let selectedVehicle = null;
        let currentUser = null;
        let cameraStream = null;
        let capturedPhoto = null;
        let documentType = 'cpf';
        let settings = {
            requiredPhoto: false
        };

        let prices = {
            pequeno: { hora1: 10, horaAdd: 5, diaria: 40 },
            grande: { hora1: 15, horaAdd: 8, diaria: 60 },
            moto: { hora1: 6, horaAdd: 3, diaria: 25 }
        };

        const TOLERANCIA_MINUTOS = 5;

        const users = {
            admin: { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrador' },
            operador: { username: 'operador', password: 'oper123', role: 'operator', name: 'Operador' }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadSettings();
            loadPrices();
            loadData();
            updateUI();
            updatePriceDisplay();
            
            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAutocomplete();
                }
            });
        });

        // ==================== AUTOCOMPLETE ====================
        function showAutocomplete(value) {
            const list = document.getElementById('autocompleteList');
            
            if (!value || value.length < 2) {
                hideAutocomplete();
                return;
            }
            
            const filtered = carModels.filter(model => 
                model.toLowerCase().includes(value.toLowerCase())
            );
            
            if (filtered.length === 0) {
                hideAutocomplete();
                return;
            }
            
            list.innerHTML = filtered.slice(0, 8).map(model => {
                const regex = new RegExp(`(${value})`, 'gi');
                const highlighted = model.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                return `<div class="autocomplete-item" onclick="selectModel('${model}')">${highlighted}</div>`;
            }).join('');
            
            list.classList.add('active');
        }

        function hideAutocomplete() {
            const list = document.getElementById('autocompleteList');
            list.classList.remove('active');
        }

        function selectModel(model) {
            document.getElementById('inputModelo').value = model;
            hideAutocomplete();
        }

        // ==================== DOCUMENT TYPE ====================
        function selectDocumentType(type) {
            documentType = type;
            
            document.getElementById('btnCPF').classList.toggle('active', type === 'cpf');
            document.getElementById('btnCNPJ').classList.toggle('active', type === 'cnpj');
            
            const input = document.getElementById('inputDocument');
            input.value = '';
            
            if (type === 'cpf') {
                input.placeholder = '000.000.000-00';
                input.maxLength = 14;
            } else {
                input.placeholder = '00.000.000/0000-00';
                input.maxLength = 18;
            }
        }

        function formatDocument() {
            const input = document.getElementById('inputDocument');
            let value = input.value.replace(/\D/g, '');
            
            if (documentType === 'cpf') {
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                }
            } else {
                if (value.length <= 14) {
                    value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                }
            }
            
            input.value = value;
        }

        function validateDocument(doc) {
            if (!doc) return true; // Opcional
            
            doc = doc.replace(/\D/g, '');
            
            if (documentType === 'cpf') {
                return doc.length === 11;
            } else {
                return doc.length === 14;
            }
        }

        // ==================== IMPROVED OCR ====================
        async function processImageWithOCR(imageData) {
            try {
                showLoading();
                document.getElementById('loadingText').textContent = 'ü§ñ IA detectando placa...';
                document.getElementById('ocrOverlay').style.display = 'flex';
                
                // Criar worker do Tesseract com configura√ß√µes otimizadas
                const worker = await Tesseract.createWorker('por', 1, {
                    logger: m => console.log(m)
                });
                
                // Configurar para melhor reconhecimento de placas
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                });
                
                const { data: { text } } = await worker.recognize(imageData);
                await worker.terminate();
                
                const plate = extractPlateFromText(text);
                
                hideLoading();
                document.getElementById('ocrOverlay').style.display = 'none';
                
                if (plate) {
                    showToast('‚úÖ Placa detectada: ' + plate);
                    document.getElementById('inputPlaca').value = plate;
                    document.getElementById('ocrResult').style.display = 'block';
                    document.getElementById('ocrResult').innerHTML = `
                        ü§ñ IA Detectou: <strong>${plate}</strong>
                        <div style="font-size: 12px; margin-top: 5px;">Voc√™ pode editar se necess√°rio</div>
                    `;
                    return plate;
                } else {
                    showToast('‚ö†Ô∏è Placa n√£o detectada. Digite manualmente.');
                    document.getElementById('ocrResult').style.display = 'block';
                    document.getElementById('ocrResult').innerHTML = `
                        ‚ö†Ô∏è Placa n√£o detectada
                        <div style="font-size: 12px; margin-top: 5px;">Digite manualmente abaixo</div>
                    `;
                    return null;
                }
            } catch (error) {
                console.error('Erro no OCR:', error);
                hideLoading();
                document.getElementById('ocrOverlay').style.display = 'none';
                showToast('‚ùå Erro ao processar imagem');
                return null;
            }
        }

        function extractPlateFromText(text) {
            // Limpar texto
            let cleanText = text.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            
            console.log('Texto OCR limpo:', cleanText);
            
            // Padr√µes de placa brasileira
            const patterns = [
                /([A-Z]{3}[0-9][A-Z0-9][0-9]{2})/,  // Mercosul: ABC1D23
                /([A-Z]{3}[0-9]{4})/,                // Antiga: ABC1234
            ];
            
            for (const pattern of patterns) {
                const match = cleanText.match(pattern);
                if (match && match[1]) {
                    let plate = match[1];
                    
                    // Corre√ß√µes inteligentes
                    plate = smartCorrectPlate(plate);
                    
                    // Validar formato
                    if (isValidPlate(plate)) {
                        return formatPlate(plate);
                    }
                }
            }
            
            // Tentar extrair qualquer sequ√™ncia de 7 caracteres
            if (cleanText.length >= 7) {
                for (let i = 0; i <= cleanText.length - 7; i++) {
                    let candidate = cleanText.substring(i, i + 7);
                    candidate = smartCorrectPlate(candidate);
                    
                    if (isValidPlate(candidate)) {
                        return formatPlate(candidate);
                    }
                }
            }
            
            return null;
        }

        function smartCorrectPlate(plate) {
            // Corre√ß√µes comuns de OCR
            const corrections = {
                'O': '0', 'I': '1', 'L': '1', 'S': '5', 'Z': '2', 
                'B': '8', 'G': '6', 'Q': '0', 'D': '0'
            };
            
            let corrected = '';
            
            for (let i = 0; i < plate.length && i < 7; i++) {
                let char = plate[i];
                
                // Primeiros 3 caracteres devem ser letras
                if (i < 3) {
                    if (/[0-9]/.test(char)) {
                        // Converter n√∫mero para letra
                        const reverseCorrections = {
                            '0': 'O', '1': 'I', '5': 'S', '2': 'Z', 
                            '8': 'B', '6': 'G'
                        };
                        char = reverseCorrections[char] || char;
                    }
                    corrected += char;
                }
                // Posi√ß√µes 4, 6, 7 devem ser n√∫meros (placa antiga)
                // Posi√ß√£o 4 e 6, 7 devem ser n√∫meros (Mercosul)
                else if (i === 3 || i === 5 || i === 6) {
                    if (/[A-Z]/.test(char)) {
                        char = corrections[char] || char;
                    }
                    corrected += char;
                }
                // Posi√ß√£o 5 pode ser letra (Mercosul) ou n√∫mero (antiga)
                else {
                    corrected += char;
                }
            }
            
            return corrected;
        }

        function isValidPlate(plate) {
            if (plate.length !== 7) return false;
            
            // Mercosul: AAA9A99
            const mercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
            // Antiga: AAA9999
            const antiga = /^[A-Z]{3}[0-9]{4}$/;
            
            return mercosul.test(plate) || antiga.test(plate);
        }

        function formatPlate(plate) {
            // ABC1234 -> ABC-1234
            return plate.substring(0, 3) + '-' + plate.substring(3);
        }

        // ==================== AUTHENTICATION ====================
        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLogin();
            }
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showToast(`‚úì Bem-vindo, ${currentUser.name}!`);
                showMainApp();
            } else {
                showToast('‚ùå Usu√°rio ou senha incorretos');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLogin();
            showToast('üëã At√© logo!');
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = currentUser.name;
            document.getElementById('settingsUsername').textContent = currentUser.username;
        }

        // ==================== PRICE MANAGEMENT ====================
        function loadPrices() {
            const saved = localStorage.getItem('prices');
            if (saved) {
                prices = JSON.parse(saved);
            }
            updatePriceInputs();
        }

        function savePrices() {
            prices = {
                pequeno: {
                    hora1: parseFloat(document.getElementById('precoPequenoHora1').value),
                    horaAdd: parseFloat(document.getElementById('precoPequenoHoraAdd').value),
                    diaria: parseFloat(document.getElementById('precoPequenoDiaria').value)
                },
                grande: {
                    hora1: parseFloat(document.getElementById('precoGrandeHora1').value),
                    horaAdd: parseFloat(document.getElementById('precoGrandeHoraAdd').value),
                    diaria: parseFloat(document.getElementById('precoGrandeDiaria').value)
                },
                moto: {
                    hora1: parseFloat(document.getElementById('precoMotoHora1').value),
                    horaAdd: parseFloat(document.getElementById('precoMotoHoraAdd').value),
                    diaria: parseFloat(document.getElementById('precoMotoDiaria').value)
                }
            };
            
            localStorage.setItem('prices', JSON.stringify(prices));
            updatePriceDisplay();
            showToast('üíæ Pre√ßos salvos com sucesso!');
        }

        function updatePrices() {
            savePrices();
        }

        function updatePriceInputs() {
            document.getElementById('precoPequenoHora1').value = prices.pequeno.hora1;
            document.getElementById('precoPequenoHoraAdd').value = prices.pequeno.horaAdd;
            document.getElementById('precoPequenoDiaria').value = prices.pequeno.diaria;
            document.getElementById('precoGrandeHora1').value = prices.grande.hora1;
            document.getElementById('precoGrandeHoraAdd').value = prices.grande.horaAdd;
            document.getElementById('precoGrandeDiaria').value = prices.grande.diaria;
            document.getElementById('precoMotoHora1').value = prices.moto.hora1;
            document.getElementById('precoMotoHoraAdd').value = prices.moto.horaAdd;
            document.getElementById('precoMotoDiaria').value = prices.moto.diaria;
        }

        function updatePriceDisplay() {
            document.getElementById('pricePequeno').textContent = `1¬™: R$ ${prices.pequeno.hora1}`;
            document.getElementById('priceGrande').textContent = `1¬™: R$ ${prices.grande.hora1}`;
            document.getElementById('priceMoto').textContent = `1¬™: R$ ${prices.moto.hora1}`;
        }

        function calcularValor(categoria, minutos) {
            if (minutos <= TOLERANCIA_MINUTOS) {
                return 0;
            }
            
            const preco = prices[categoria];
            const horas = Math.ceil((minutos - TOLERANCIA_MINUTOS) / 60);
            
            if (horas > 12) {
                const dias = Math.ceil(horas / 24);
                return dias * preco.diaria;
            }
            
            if (horas === 1) {
                return preco.hora1;
            } else {
                return preco.hora1 + ((horas - 1) * preco.horaAdd);
            }
        }

        function calcularMinutos(entrada) {
            const agora = new Date();
            const entradaDate = new Date(entrada);
            return Math.floor((agora - entradaDate) / (1000 * 60));
        }

        // ==================== DATA PERSISTENCE ====================
        function saveData() {
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
        }

        function loadData() {
            const saved = localStorage.getItem('vehicles');
            if (saved) {
                vehicles = JSON.parse(saved);
            }
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('settings');
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // Update UI
            const toggle = document.getElementById('toggleRequiredPhoto');
            if (toggle) {
                if (settings.requiredPhoto) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // ==================== CAMERA ====================
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('cameraControls').style.display = 'flex';
                document.getElementById('btnStartCamera').style.display = 'none';
                
                showToast('üì∑ C√¢mera ativada');
            } catch (error) {
                showToast('‚ùå N√£o foi poss√≠vel acessar a c√¢mera');
                console.error('Camera error:', error);
            }
        }

        async function capturePhotoWithOCR() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('ocrCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.95);
            
            document.getElementById('cameraPreview').src = capturedPhoto;
            document.getElementById('cameraPreview').style.display = 'block';
            video.style.display = 'none';
            document.getElementById('cameraControls').querySelector('.btn-camera').style.display = 'none';
            document.getElementById('btnRetake').style.display = 'flex';
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            showToast('‚úì Foto capturada!');
            
            // Processar OCR
            await processImageWithOCR(capturedPhoto);
        }

        function retakePhoto() {
            capturedPhoto = null;
            document.getElementById('cameraPreview').style.display = 'none';
            document.getElementById('btnRetake').style.display = 'none';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('inputPlaca').value = '';
            startCamera();
        }

        // ==================== MODAL MANAGEMENT ====================
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(view).classList.add('active');
            event.target.closest('.nav-tab').classList.add('active');
            
            updateUI();
        }

        function openEntryModal() {
            document.getElementById('entryModal').classList.add('active');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').classList.remove('active');
            clearForm();
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        }

        function openExitModal(vehicle) {
            selectedVehicle = vehicle;
            const minutos = calcularMinutos(vehicle.entrada);
            const valor = calcularValor(vehicle.categoria, minutos);
            
            // Reset document type
            selectDocumentType('cpf');
            document.getElementById('inputDocument').value = '';
            
            let photoHtml = '';
            if (vehicle.foto) {
                photoHtml = `<img src="${vehicle.foto}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;">`;
            }
            
            let valorHtml = '';
            if (minutos <= TOLERANCIA_MINUTOS) {
                valorHtml = `
                    <div class="summary-row">
                        <span>Tempo:</span>
                        <span>${minutos} minuto(s)</span>
                    </div>
                    <div class="summary-row" style="color: #10b981; font-size: 20px;">
                        <span>‚è∞ Toler√¢ncia (GR√ÅTIS):</span>
                        <span>R$ 0,00</span>
                    </div>
                `;
            } else {
                valorHtml = `
                    <div class="summary-row">
                        <span>Tempo:</span>
                        <span>${calcularTempoString(vehicle.entrada)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Valor Total:</span>
                        <span style="color: #059669;">R$ ${valor.toFixed(2)}</span>
                    </div>
                `;
            }
            
            document.getElementById('exitSummary').innerHTML = `
                ${photoHtml}
                <div class="summary-row">
                    <span>Placa:</span>
                    <span style="font-weight: 700; font-family: monospace;">${vehicle.placa}</span>
                </div>
                <div class="summary-row">
                    <span>Modelo:</span>
                    <span>${vehicle.modelo || '-'}</span>
                </div>
                <div class="summary-row">
                    <span>Categoria:</span>
                    <span style="text-transform: capitalize;">${vehicle.categoria}</span>
                </div>
                <div class="summary-row">
                    <span>Entrada:</span>
                    <span>${formatDateTime(vehicle.entrada)}</span>
                </div>
                ${valorHtml}
            `;
            
            document.getElementById('exitModal').classList.add('active');
        }

        function closeExitModal() {
            document.getElementById('exitModal').classList.remove('active');
            selectedVehicle = null;
        }

        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.category-btn').classList.add('active');
        }

        function clearForm() {
            document.getElementById('inputPlaca').value = '';
            document.getElementById('inputModelo').value = '';
            selectedCategory = 'pequeno';
            capturedPhoto = null;
            
            document.getElementById('cameraVideo').style.display = 'none';
            document.getElementById('cameraPreview').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            document.getElementById('cameraControls').style.display = 'none';
            document.getElementById('btnStartCamera').style.display = 'block';
            document.getElementById('ocrResult').style.display = 'none';
            
            document.querySelectorAll('.category-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            
            hideAutocomplete();
        }

        async function registerEntry() {
            const placa = document.getElementById('inputPlaca').value.trim().toUpperCase();
            
            if (!placa) {
                showToast('‚ùå Informe a placa do ve√≠culo');
                return;
            }
            
            // Verificar foto obrigat√≥ria APENAS se estiver ativada
            if (settings.requiredPhoto && !capturedPhoto) {
                showToast('‚ùå Foto √© obrigat√≥ria (ative nas configura√ß√µes para desativar)');
                return;
            }

            const vehicle = {
                id: Date.now().toString(),
                placa: placa,
                categoria: selectedCategory,
                modelo: document.getElementById('inputModelo').value.trim(),
                foto: capturedPhoto || '',
                entrada: new Date().toISOString(),
                saida: null,
                controleNum: `${60200 + vehicles.length + 1}`,
                status: 'ativo',
                usuario: currentUser.username,
                notified: false
            };

            vehicles.push(vehicle);
            saveData();
            
            closeEntryModal();
            switchView('patio');
            updateUI();
            showToast('‚úì Entrada registrada!');
        }

        async function registerExit() {
            if (!selectedVehicle) return;

            const document_value = document.getElementById('inputDocument').value.trim();
            
            if (document_value && !validateDocument(document_value)) {
                showToast(`‚ùå ${documentType.toUpperCase()} inv√°lido`);
                return;
            }

            const saida = new Date().toISOString();
            const minutos = calcularMinutos(selectedVehicle.entrada);
            const valor = calcularValor(selectedVehicle.categoria, minutos);

            const index = vehicles.findIndex(v => v.id === selectedVehicle.id);
            vehicles[index] = {
                ...selectedVehicle,
                saida: saida,
                minutosEstacionado: minutos,
                valor: valor,
                status: 'finalizado',
                documento: document_value || '',
                documentoTipo: document_value ? documentType : ''
            };

            saveData();
            
            closeExitModal();
            updateUI();
            
            if (valor === 0) {
                showToast(`‚úì Sa√≠da registrada! Toler√¢ncia aplicada - GR√ÅTIS`);
            } else {
                showToast(`‚úì Sa√≠da registrada! Valor: R$ ${valor.toFixed(2)}`);
            }
        }

        function calcularTempoString(entrada) {
            const minutos = calcularMinutos(entrada);
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            return `${horas}h ${mins}m`;
        }

        function formatDateTime(iso) {
            const date = new Date(iso);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==================== FILTERS ====================
        function filterVehicles(view) {
            updateUI();
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            updateStats();
            updatePatioList();
            updateHistoricoList();
        }

        function updateStats() {
            const ativos = vehicles.filter(v => v.status === 'ativo');
            const finalizados = vehicles.filter(v => v.status === 'finalizado');
            const receita = finalizados.reduce((sum, v) => sum + (v.valor || 0), 0);

            document.getElementById('statAtivos').textContent = ativos.length;
            document.getElementById('statReceita').textContent = `R$ ${receita.toFixed(0)}`;
            document.getElementById('statFinalizados').textContent = finalizados.length;
            document.getElementById('statTotal').textContent = vehicles.length;
            document.getElementById('patioCount').textContent = `(${ativos.length})`;

            const pequenos = ativos.filter(v => v.categoria === 'pequeno').length;
            const grandes = ativos.filter(v => v.categoria === 'grande').length;
            const motos = ativos.filter(v => v.categoria === 'moto').length;

            document.getElementById('categoryStats').innerHTML = `
                <div style="display: flex; justify-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280;">üöó Pequenos</span>
                    <span style="font-weight: 700; color: #3b82f6; font-size: 20px;">${pequenos}</span>
                </div>
                <div style="display: flex; justify-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280;">üöô Grandes</span>
                    <span style="font-weight: 700; color: #10b981; font-size: 20px;">${grandes}</span>
                </div>
                <div style="display: flex; justify-between; padding: 10px 0;">
                    <span style="color: #6b7280;">üèçÔ∏è Motos</span>
                    <span style="font-weight: 700; color: #8b5cf6; font-size: 20px;">${motos}</span>
                </div>
            `;
        }

        function updatePatioList() {
            const searchTerm = document.getElementById('searchPatio').value.toLowerCase();
            const filter = document.getElementById('filterPatio').value;
            
            let filtered = vehicles.filter(v => v.status === 'ativo');
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    v.placa.toLowerCase().includes(searchTerm) ||
                    (v.modelo && v.modelo.toLowerCase().includes(searchTerm)) ||
                    v.controleNum.includes(searchTerm)
                );
            }
            
            if (filter !== 'todos') {
                filtered = filtered.filter(v => v.categoria === filter);
            }

            const html = filtered.length > 0 ? filtered.map(v => createVehicleCard(v)).join('') : 
                '<div class="empty-state"><div style="font-size: 48px;">üöó</div><p>Nenhum ve√≠culo no p√°tio</p></div>';
            
            document.getElementById('patioList').innerHTML = html;
        }

        function updateHistoricoList() {
            const searchTerm = document.getElementById('searchHistorico').value.toLowerCase();
            const filter = document.getElementById('filterHistorico').value;
            
            let filtered = vehicles.filter(v => v.status === 'finalizado');
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    v.placa.toLowerCase().includes(searchTerm) ||
                    (v.modelo && v.modelo.toLowerCase().includes(searchTerm)) ||
                    v.controleNum.includes(searchTerm)
                );
            }
            
            if (filter !== 'todos') {
                filtered = filtered.filter(v => v.categoria === filter);
            }

            const html = filtered.length > 0 ? filtered.map(v => createVehicleCard(v)).join('') : 
                '<div class="empty-state"><div style="font-size: 48px;">üìã</div><p>Nenhum registro no hist√≥rico</p></div>';
            
            document.getElementById('historicoList').innerHTML = html;
        }

        function createVehicleCard(vehicle) {
            const isActive = vehicle.status === 'ativo';
            const categoryIcon = vehicle.categoria === 'pequeno' ? 'üöó' : vehicle.categoria === 'grande' ? 'üöô' : 'üèçÔ∏è';
            
            const minutos = isActive ? calcularMinutos(vehicle.entrada) : (vehicle.minutosEstacionado || 0);
            const isLongStay = minutos >= 180;
            const isFree = minutos <= TOLERANCIA_MINUTOS;
            
            let photoHtml = '';
            if (vehicle.foto) {
                photoHtml = `<img src="${vehicle.foto}" class="vehicle-photo">`;
            }
            
            let infoHtml = '';
            
            if (vehicle.modelo) {
                infoHtml += `<div class="vehicle-info">üöó ${vehicle.modelo}</div>`;
            }
            
            infoHtml += `<div class="vehicle-info">üïê Entrada: ${formatDateTime(vehicle.entrada)}</div>`;
            
            if (isActive) {
                if (isFree) {
                    infoHtml += `<div class="vehicle-info free">üéÅ Toler√¢ncia (${minutos} min) - GR√ÅTIS</div>`;
                } else {
                    const tempoClass = isLongStay ? 'vehicle-info alert' : 'vehicle-info highlight';
                    const tempoIcon = isLongStay ? '‚ö†Ô∏è' : '‚è±Ô∏è';
                    infoHtml += `<div class="${tempoClass}">${tempoIcon} Tempo: ${calcularTempoString(vehicle.entrada)}</div>`;
                }
            } else {
                infoHtml += `<div class="vehicle-info">üö™ Sa√≠da: ${formatDateTime(vehicle.saida)}</div>`;
                if (vehicle.documento) {
                    const docLabel = vehicle.documentoTipo === 'cpf' ? 'CPF' : 'CNPJ';
                    infoHtml += `<div class="vehicle-info">üìÑ ${docLabel}: ${vehicle.documento}</div>`;
                }
                if (vehicle.valor === 0) {
                    infoHtml += `<div class="vehicle-info price">üéÅ Toler√¢ncia - GR√ÅTIS</div>`;
                } else {
                    infoHtml += `<div class="vehicle-info price">üí∞ Valor Pago: R$ ${vehicle.valor.toFixed(2)}</div>`;
                }
            }

            const buttonsHtml = isActive ? `
                <div class="btn-group">
                    <button class="btn-exit btn-print" onclick='alert("Ticket impresso!")'>
                        üñ®Ô∏è Ticket
                    </button>
                    <button class="btn-exit" onclick='openExitModal(${JSON.stringify(vehicle).replace(/'/g, "&apos;")})'>
                        üö™ Sa√≠da
                    </button>
                </div>
            ` : '';

            return `
                <div class="vehicle-card">
                    <div class="vehicle-header ${!isActive ? 'finished' : ''}">
                        <div>
                            <div class="vehicle-plate">${vehicle.placa}</div>
                            <div class="vehicle-control">Controle: ${vehicle.controleNum}</div>
                            <div class="vehicle-category">${categoryIcon} ${vehicle.categoria.toUpperCase()}</div>
                        </div>
                        ${photoHtml}
                    </div>
                    <div class="vehicle-body">
                        ${infoHtml}
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }

        // ==================== SETTINGS ====================
        function toggleSetting(element, setting) {
            element.classList.toggle('active');
            settings[setting] = element.classList.contains('active');
            saveSettings();
            
            const messages = {
                requiredPhoto: settings.requiredPhoto ? 'üì∑ Foto obrigat√≥ria ativada' : 'üì∑ Foto opcional'
            };
            
            showToast(messages[setting]);
        }

        // ==================== UI HELPERS ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    </script>
</body>
</html>
